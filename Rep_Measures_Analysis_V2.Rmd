---
title: "Longitudinal data Analysis"
author: "Recep Yildirim"
date: "5/7/2021"
output: pdf_document
---
```{r}
library(readr)
gaussian_data_G10 <- read_csv("gaussian_data_G10.csv")
count_data_G10 <- read_csv("count_data_G10.csv")
```


```{r}
dataG<-na.omit(gaussian_data_G10)
dataC<-na.omit(count_data_G10)
```




Transform the non-Gaussian outcome ‘tot.vase.days’ into a longitudinal binary outcome ..
```{r}
for (i in 8:32){
  dataC[i]<-NA
}

colnames(dataC)<-c("subplotID","flowerID","garden","species","rater","compound","tot.vase.days",
                   1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25)
```


```{r}
for (k in 1:25){
for (i in 1:1392){
  if (as.integer(dataC[i,7]) >= k){
    dataC[i,(k+7)] <- 1
  }else{
    dataC[i,(k+7)] <- 0
    }
  }
}
dataC<-dataC*1
```


```{r}
numbers<-1:25
cols<-as.character(numbers)
dataC[cols] <- lapply(dataC[cols], factor)
```


```{r}
library(lcsm)
library(ggplot2)
library(tidyr)
library(dplyr)
library(stringr)
library(car)
```


wide to long...
```{r}
dataG$Flower_index<-factor(dataG$Flower_index)

colnames(dataG)<-c("Flower_index",0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,"Compound","Rater","Type","Garden","Subplot")

dataG_long <- gather(dataG, Days, Width, "0":"20", factor_key=TRUE)
```

```{r}
dataC$flowerID<-factor(dataC$flowerID)
dataC_long <- gather(dataC, Days, Freshness, "1":"25", factor_key=TRUE)
```


```{r}
dataG_long$Garden<-as.factor(dataG_long$Garden)
dataG_long$Type<-as.factor(dataG_long$Type)
dataG_long$Compound<-as.factor(dataG_long$Compound)
dataG_long$Subplot<-as.factor(dataG_long$Subplot)

ggplot(dataG_long, aes(x = Days, y = Width)) +
  geom_line(aes(group = Garden, color=Garden), alpha = 0.8) +
  geom_smooth(se = TRUE, size = 7) +
  theme_bw(base_size = 10) +
  xlab("Number of Days") +
  ylab("Width")

ggplot(dataG_long, aes(x = Days, y = Width)) +
  geom_line(aes(group = Type, color=Type), alpha = 0.8) +
  geom_smooth(se = FALSE, size = 10) +
  theme_bw(base_size = 10) +
  xlab("Number of Days") +
  ylab("Width")
```

```{r}
x_var_list<-c(0:20)

plot_trajectories(data = dataG,
                  id_var = "Flower_index", 
                  var_list = x_var_list,
                  xlab = "Days", ylab = "Value",
                  title_n = TRUE)

ggplot(dataG_long, aes(x = Days, y = Width)) +
  geom_line(aes(group = Compound, color=Compound), alpha = 0.8) +
  geom_smooth(se = FALSE, size = 0.3) +
  theme_bw(base_size = 10) +
  xlab("Number of Days") +
  ylab("Width")

ggplot(dataG_long,aes(x=Compound, y=Width, fill = Compound)) + 
  geom_boxplot()

```

```{r}
ggplot(dataG_long,aes(x=Garden, y=Width, fill = Garden)) + 
  geom_boxplot()

ggplot(dataG_long,aes(x=Type, y=Width, fill = Type)) + 
  geom_boxplot()

ggplot(dataG_long,aes(x=Subplot, y=Width, fill = Subplot)) + 
  geom_boxplot()
```



In broad terms, fixed effects are variables that we expect will have an effect on the dependent/response variable: they’re what you call explanatory variables in a standard linear regression. In our case, we are interested in making conclusions about how dragon body length impacts the dragon’s test score. So body length is a fixed effect and test score is the dependent variable.

On the other hand, random effects are usually grouping factors for which we are trying to control. They are always categorical, as you can’t force R to treat a continuous variable as a random effect. A lot of the time we are not specifically interested in their impact on the response variable, but we know that they might be influencing the patterns we see.

outcome = the variable we wish to explain or predict

fixed_effects = terms representing the average trajectory

random_effects = reflect deviations from the average trajectory for each individual

individual = ID for individuals that were measured repeatedly


lmer(outcome ~ fixed_effects + (random_effects | individual), data = data)


Response ∼ Fixed effects covariates + (Random effects covariate | Identifiers)

the random effects are assumed to be normally distributed

The syntax Width ~ (1|Subplot) tells lme4::lmer to fit a model with a global intercept (1) and a random Subplot effect (1|Subplot). The | operator is the cornerstone of random effect modelng with lme4::lmer

```{r}
library(nlme)
library(dplyr)
library(lme4)
library(lmerTest)
library(multcomp)
library(sjPlot)
library(sjmisc)

dataG_long$Days<-as.numeric(dataG_long$Days)

mG.lmm <- lmer(Width ~ Compound + Type + Garden + Days + (1 | Subplot), data = dataG_long)

summary(mG.lmm)
```


```{r}
VarCorr(mG.lmm)
```

```{r}
between_subplots<-0.2469**2
within_subplots<-1.3269**2 

between_subplots / (between_subplots + within_subplots)
```
It means that the ‘subplot’ factor explains 3.3% of the total variability, after
correction for the fixed effects.

```{r}
confint(mG.lmm)

plot_summs(mG.lmm)
```

```{r}
Anova(mG.lmm, type = 3)
```



```{r}
dataC_long$garden<-as.factor(dataC_long$garden)
dataC_long$species<-as.factor(dataC_long$species)
dataC_long$rater<-as.factor(dataC_long$rater)
dataC_long$compound<-as.factor(dataC_long$compound)
dataC_long$subplotID<-as.factor(dataC_long$subplotID)
dataC_long$Freshness<-as.factor(dataC_long$Freshness)
dataC_long$Days<-as.numeric(dataC_long$Days)

```

```{r}

mC.glmm2 <- glmer(formula = Freshness ~ Days + compound + species + garden + rater + (1|subplotID), data = dataC_long, family = binomial)
summary(mC.glmm2)

```

```{r}
exp(confint(mC.glmm2, method= 'Wald'))
```


```{r}
Anova(mC.glmm2, type=3)
```


```{r}
c<-coef(mC.glmm2)
```

```{r}
plot(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x))),ylim=c(0,1), type="l",col=4,lwd=2,xlab="Days", ylab="Estimated Probability of Freshness", cex.lab=1.3)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,3]))),col=3,lwd=2)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,5]))),col=2,lwd=2)
  legend("topright", legend=c("Water","Compound 2","Compound 4"), col=c(4,3,2),lwd=2)
```

```{r}
plot(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x))),ylim=c(0,1), type="l",col=4,lwd=2,xlab="Days", ylab="Estimated Probability of Freshness", cex.lab=1.3)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,17]))),col=3,lwd=2)
  legend("topright", legend=c("Species 1","Species 2"), col=c(4,3),lwd=2)
```
```{r}
plot(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x))),ylim=c(0,1), type="l",col=4,lwd=2,xlab="Days", ylab="Estimated Probability of Freshness", cex.lab=1.3)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,18]))),col=3,lwd=2)
  legend("topright", legend=c("Garden 1","Garden 2"), col=c(4,3),lwd=2)
```



```{r}
plot(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x))),ylim=c(0,1), type="l",col=4,lwd=2,xlab="Days", ylab="Estimated Probability of Freshness", cex.lab=1.3)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,19]))),col=3,lwd=2)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,20]))),col=2,lwd=2)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,21]))),col=1,lwd=2)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,22]))),col=5,lwd=2)
  lines(x,1/(1+exp(-(c$subplotID[2,1]+c$subplotID[2,2]*x + c$subplotID[2,23]))),col=7,lwd=2)
  legend("topright", legend=c("Rater 1","Rater 2","Rater 3","Rater 4","Rater 5","Rater 6"), col=c(4,3,2,1,5,7),lwd=2)
```

```{r}
VarCorr(mC.glmm2)

plot_summs(mC.glmm)


```






